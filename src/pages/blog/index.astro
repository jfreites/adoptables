---
import Layout from "@/layouts/Layout.astro";

import { getPosts } from "@/services/blog";
import {formatDate} from "@/lib/utils.ts";

const POSTS_PER_PAGE = 9;
const url = new URL(Astro.request.url);
const currentPageParam = Number(url.searchParams.get("page") ?? "1");

const page = Number.isFinite(currentPageParam) ? Math.max(1, currentPageParam) : 1;

const { posts, total } = await getPosts(page, POSTS_PER_PAGE);
const totalPages = Math.max(1, Math.ceil(total / POSTS_PER_PAGE));

const pageHref = (p: number) => `?page=${p}`;
---
<Layout>
    {/* Hero Section */}
    <section class="bg-gradient-to-br from-primary/10 via-secondary/10 to-accent/10 py-20">
        <div class="container mx-auto px-4">
        <div class="text-center max-w-3xl mx-auto">
            <h1 class="text-5xl md:text-6xl font-bold mb-6">
            Adopta Con Amor Blog
            </h1>
            <p class="text-xl text-muted-foreground">
            Consejos expertos, historias hermosas, y guias esenciales para "pet lovers".
            </p>
        </div>
        </div>
    </section>

    {/* Blog Posts Grid */}
    <section class="py-20">
        <div class="container mx-auto px-4">
            {posts.length ? posts.map((post) => 
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <article class="flex flex-col overflow-hidden border-2 hover:border-primary transition-all duration-300 hover:shadow-lg rounded-3xl group bg-card">
                    <div class="relative overflow-hidden aspect-[4/3]">
                        <img
                        src={post.image_path}
                        alt={post.title}
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                        loading="lazy"
                        decoding="async"
                        onerror="this.onerror=null;this.src='/fallbacks/post-placeholder.jpg'"
                        />
                    </div>
                    <div class="p-6 space-y-3 flex-grow">
                        <div class="flex items-center gap-2 text-sm text-muted-foreground">
                        <!-- Calendar icon -->
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                        <span>{formatDate(post.created_at)}</span>
                        </div>
                        <h3 class="text-xl font-bold">{post.title}</h3>
                        <p class="text-muted-foreground">{post.excerpt}</p>
                    </div>
                    <div class="p-6 pt-0 mt-auto">
                        <a href={`/blog/${post.slug}`} class="rounded-full w-full inline-flex items-center justify-center h-11 px-6 border-2 border-input hover:shadow-sm">
                        Leer Más
                        </a>
                    </div>
                    </article>
                </div>
            ) : <p>No hay publicaciones aún.</p>}
        </div>
    </section>
</Layout>