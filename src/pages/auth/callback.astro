---
import { supabase } from '@/lib/supabase'
import Layout from '@/layouts/Layout.astro'

const url = Astro.url
const code = url.searchParams.get('code')

let error = null
let success = false

if (code) {
  const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code)

  if (exchangeError) {
    error = exchangeError.message
  } else if (data.session) {
    // Set cookies for session management
    Astro.cookies.set('sb-access-token', data.session.access_token, {
      path: '/',
      maxAge: 60 * 60 * 24 * 7, // 7 days
      httpOnly: true,
      secure: import.meta.env.PROD,
      sameSite: 'lax'
    })

    Astro.cookies.set('sb-refresh-token', data.session.refresh_token, {
      path: '/',
      maxAge: 60 * 60 * 24 * 7, // 7 days
      httpOnly: true,
      secure: import.meta.env.PROD,
      sameSite: 'lax'
    })

    success = true
    // Redirect to dashboard
    return Astro.redirect('/dashboard')
  }
} else {
  error = 'No verification code found'
}
---

<Layout>
  <div class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div>
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
          Email Verification
        </h2>
      </div>

      {error ? (
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          <p class="font-bold">Verification Failed</p>
          <p>{error}</p>
          <a href="/login" class="text-red-600 hover:text-red-800 underline mt-2 inline-block">
            Back to Login
          </a>
        </div>
      ) : success ? (
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
          <p class="font-bold">Email Verified Successfully!</p>
          <p>You are being redirected to your dashboard...</p>
        </div>
      ) : (
        <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
          <p>Processing your verification...</p>
        </div>
      )}
    </div>
  </div>
</Layout>
